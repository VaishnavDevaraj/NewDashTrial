<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ dashboard.name }} - Smart Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .grid-stack-item-content {
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .visualization-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .visualization-title {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        .visualization-body {
            height: calc(100% - 30px);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard.index') }}">Smart Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.index') }}">Dashboards</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('history.view_history') }}">History</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            {{ session.get('name') or session.get('email') }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('auth.profile') }}">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="container-fluid mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ dashboard.name }}</h2>
        <div>
            <button class="btn btn-outline-primary" id="addVisualizationBtn">
                <i class="bi bi-plus-lg"></i> Add Visualization
            </button>
            <button class="btn btn-outline-secondary" id="saveLayoutBtn">
                <i class="bi bi-save"></i> Save Layout
            </button>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="grid-stack"></div>
</div>

<!-- Add Visualization Modal -->
<div class="modal fade" id="addVisualizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Visualization</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="datasetSelect" class="form-label">Select Dataset</label>
                    <select class="form-select" id="datasetSelect">
                        <option value="">-- Select a dataset --</option>
                        {% for dataset in datasets %}
                            <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="visualizationSuggestions" class="mt-4" style="display: none;">
                    <h6>Suggested Visualizations</h6>
                    <div class="row" id="suggestionsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading suggestions...</p>
                        </div>
                    </div>
                </div>
                
                <div id="customVisualization" class="mt-4" style="display: none;">
                    <h6>Custom Visualization</h6>
                    <div class="mb-3">
                        <label for="vizTypeSelect" class="form-label">Visualization Type</label>
                        <select class="form-select" id="vizTypeSelect">
                            <option value="">-- Select type --</option>
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="scatter">Scatter Plot</option>
                            <option value="pie">Pie Chart</option>
                            <option value="histogram">Histogram</option>
                            <option value="box">Box Plot</option>
                            <option value="heatmap">Heatmap</option>
                        </select>
                    </div>
                    
                    <div id="vizConfigForm" class="row">
                        <!-- Dynamic form fields will be added here based on viz type -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" id="toggleCustomBtn">Create Custom Visualization</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createCustomVizBtn" style="display: none;">Create</button>
            </div>
        </div>
    </div>
</div>
<div id="dashboardData" 
     data-dashboard-id="{{ dashboard.id }}" 
     data-visualizations="{{ visualizations|tojson|e }}">
</div>

<script>
    // Then in your JavaScript:
    const dashboardId = JSON.parse(dataElement.getAttribute('data-dashboard-id'));
    const visualizations = JSON.parse(dataElement.getAttribute('data-visualizations'));
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
<script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
<script>
    // Initialize GridStack
    const grid = GridStack.init({
        column: 12,
        cellHeight: 50,
        animate: true,
        resizable: {
            handles: 'all'
        }
    });
    
    
    
    // Add existing visualizations to the grid
    visualizations.forEach(viz => {
        const position = viz.position || { x: 0, y: 0, w: 6, h: 6 };
        
        const vizNode = {
            id: viz.id,
            x: position.x || 0,
            y: position.y || 0,
            w: position.w || 6,
            h: position.h || 6,
            content: `
                <div class="visualization-container" data-viz-id="${viz.id}">
                    <div class="visualization-header">
                        <h5 class="visualization-title">${viz.config.title || 'Visualization'}</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary btn-sm edit-viz-btn" data-viz-id="${viz.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm delete-viz-btn" data-viz-id="${viz.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="visualization-body" id="viz-${viz.id}"></div>
                </div>
            `
        };
        
        grid.addWidget(vizNode);
        
        // Render the visualization
        fetch(`/dashboard/api/create_visualization`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dashboard_id: dashboardId,
                dataset_id: viz.dataset_id,
                type: viz.type,
                config: viz.config
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.data) {
                Plotly.newPlot(`viz-${viz.id}`, data.data.data, data.data.layout);
            }
        })
        .catch(error => {
            console.error('Error rendering visualization:', error);
            document.getElementById(`viz-${viz.id}`).innerHTML = `
                <div class="alert alert-danger">
                    Failed to render visualization. Error: ${error.message}
                </div>
            `;
        });
    });
    
    // Save layout button
    document.getElementById('saveLayoutBtn').addEventListener('click', function() {
        const serializedLayout = grid.save();
        
        // Convert to format expected by backend
        const layout = {};
        serializedLayout.forEach(item => {
            layout[item.id] = {
                x: item.x,
                y: item.y,
                w: item.w,
                h: item.h
            };
        });
        
        // Save layout to server
        fetch(`/dashboard/api/update_dashboard_layout`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dashboard_id: dashboardId,
                layout: layout
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Layout saved successfully');
            } else {
                alert('Failed to save layout: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving layout:', error);
            alert('Failed to save layout: ' + error.message);
        });
    });
    
    // Add visualization button
    const addVisualizationModal = new bootstrap.Modal(document.getElementById('addVisualizationModal'));
    
    document.getElementById('addVisualizationBtn').addEventListener('click', function() {
        // Reset the modal
        document.getElementById('datasetSelect').value = '';
        document.getElementById('visualizationSuggestions').style.display = 'none';
        document.getElementById('customVisualization').style.display = 'none';
        document.getElementById('suggestionsContainer').innerHTML = '';
        document.getElementById('toggleCustomBtn').textContent = 'Create Custom Visualization';
        document.getElementById('createCustomVizBtn').style.display = 'none';
        
        addVisualizationModal.show();
    });
    
    // Dataset selection
    document.getElementById('datasetSelect').addEventListener('change', function() {
        const datasetId = this.value;
        
        if (!datasetId) {
            document.getElementById('visualizationSuggestions').style.display = 'none';
            return;
        }
        
        // Show suggestions section with loading indicator
        document.getElementById('visualizationSuggestions').style.display = 'block';
        document.getElementById('suggestionsContainer').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading suggestions...</p>
            </div>
        `;
        
        // Fetch visualization suggestions
        fetch(`/dashboard/api/dataset/${datasetId}/suggest_visualizations`)
            .then(response => response.json())
            .then(suggestions => {
                let suggestionsHtml = '';
                
                if (suggestions.length === 0) {
                    suggestionsHtml = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                No visualization suggestions available for this dataset.
                            </div>
                        </div>
                    `;
                } else {
                    suggestions.forEach((suggestion, index) => {
                        suggestionsHtml += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">${suggestion.title}</h6>
                                        <p class="card-text small">${suggestion.description}</p>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <button class="btn btn-primary btn-sm w-100 add-suggestion-btn" 
                                                data-suggestion-index="${index}"
                                                data-dataset-id="${datasetId}">
                                            Add to Dashboard
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('suggestionsContainer').innerHTML = suggestionsHtml;
                
                // Add event listeners to suggestion buttons
                document.querySelectorAll('.add-suggestion-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const suggestionIndex = parseInt(this.getAttribute('data-suggestion-index'));
                        const datasetId = this.getAttribute('data-dataset-id');
                        const suggestion = suggestions[suggestionIndex];
                        
                        // Create the visualization
                        createVisualization(datasetId, suggestion.type, suggestion.config);
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                document.getElementById('suggestionsContainer').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Failed to load visualization suggestions. Error: ${error.message}
                        </div>
                    </div>
                `;
            });
    });
    
    // Toggle between suggested and custom visualization
    document.getElementById('toggleCustomBtn').addEventListener('click', function() {
        const customVizSection = document.getElementById('customVisualization');
        const suggestionsSection = document.getElementById('visualizationSuggestions');
        const createCustomVizBtn = document.getElementById('createCustomVizBtn');
        
        if (customVizSection.style.display === 'none') {
            customVizSection.style.display = 'block';
            suggestionsSection.style.display = 'none';
            this.textContent = 'Show Suggestions';
            createCustomVizBtn.style.display = 'block';
        } else {
            customVizSection.style.display = 'none';
            suggestionsSection.style.display = 'block';
            this.textContent = 'Create Custom Visualization';
            createCustomVizBtn.style.display = 'none';
        }
    });
    
    // Visualization type selection
    document.getElementById('vizTypeSelect').addEventListener('change', function() {
        const vizType = this.value;
        const configForm = document.getElementById('vizConfigForm');
        const datasetId = document.getElementById('datasetSelect').value;
        
        if (!vizType || !datasetId) {
            configForm.innerHTML = '';
            return;
        }
        
        // Fetch dataset columns for the form
        fetch(`/dashboard/api/dataset/${datasetId}/summary`)
            .then(response => response.json())
            .then(summary => {
                let formHtml = `
                    <div class="col-12 mb-3">
                        <label for="vizTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="vizTitle" placeholder="Visualization Title">
                    </div>
                `;
                
                // Add form fields based on visualization type
                if (vizType === 'bar') {
                    formHtml += `
                        <div class="col-md-6 mb-3">
                            <label for="xAxisSelect" class="form-label">X-Axis (Categories)</label>
                            <select class="form-control" id="xAxisSelect">
                                <option value="">-- Select column --</option>
                                ${summary.categorical_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="yAxisSelect" class="form-label">Y-Axis (Values, optional)</label>
                            <select class="form-control" id="yAxisSelect">
                                <option value="">-- Count of X-Axis --</option>
                                ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (vizType === 'line') {
                    formHtml += `
                        <div class="col-md-6 mb-3">
                            <label for="xAxisSelect" class="form-label">X-Axis (Time/Categories)</label>
                            <select class="form-control" id="xAxisSelect">
                                <option value="">-- Select column --</option>
                                ${summary.datetime_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                ${summary.categorical_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                            </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="yAxisSelect" class="form-label">Y-Axis (Values)</label>
                                <select class="form-control" id="yAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    } else if (vizType === 'scatter') {
                        formHtml += `
                            <div class="col-md-6 mb-3">
                                <label for="xAxisSelect" class="form-label">X-Axis</label>
                                <select class="form-control" id="xAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="yAxisSelect" class="form-label">Y-Axis</label>
                                <select class="form-control" id="yAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="colorSelect" class="form-label">Color By (optional)</label>
                                <select class="form-control" id="colorSelect">
                                    <option value="">-- None --</option>
                                    ${summary.categorical_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    } else if (vizType === 'pie') {
                        formHtml += `
                            <div class="col-md-6 mb-3">
                                <label for="namesSelect" class="form-label">Categories</label>
                                <select class="form-control" id="namesSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.categorical_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="valuesSelect" class="form-label">Values</label>
                                <select class="form-control" id="valuesSelect">
                                    <option value="count">Count of Categories</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    } else if (vizType === 'histogram') {
                        formHtml += `
                            <div class="col-md-6 mb-3">
                                <label for="xAxisSelect" class="form-label">Value</label>
                                <select class="form-control" id="xAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nbinsInput" class="form-label">Number of Bins</label>
                                <input type="number" class="form-control" id="nbinsInput" value="20" min="5" max="100">
                            </div>
                        `;
                    } else if (vizType === 'box') {
                        formHtml += `
                            <div class="col-md-6 mb-3">
                                <label for="xAxisSelect" class="form-label">Categories</label>
                                <select class="form-control" id="xAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.categorical_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="yAxisSelect" class="form-label">Values</label>
                                <select class="form-control" id="yAxisSelect">
                                    <option value="">-- Select column --</option>
                                    ${summary.numeric_columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    } else if (vizType === 'heatmap') {
                        formHtml += `
                            <div class="col-12 mb-3">
                                <label class="form-label">Columns to Include</label>
                                <div class="row" id="heatmapColumnsContainer">
                                    ${summary.numeric_columns.map(col => `
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input heatmap-column-checkbox" type="checkbox" value="${col}" id="check_${col}">
                                                <label class="form-check-label" for="check_${col}">
                                                    ${col}
                                                </label>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    configForm.innerHTML = formHtml;
                })
                .catch(error => {
                    console.error('Error fetching dataset summary:', error);
                    configForm.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Failed to load column information. Error: ${error.message}
                            </div>
                        </div>
                    `;
                });
        });
        
        // Create custom visualization button
        document.getElementById('createCustomVizBtn').addEventListener('click', function() {
            const datasetId = document.getElementById('datasetSelect').value;
            const vizType = document.getElementById('vizTypeSelect').value;
            
            if (!datasetId || !vizType) {
                alert('Please select a dataset and visualization type');
                return;
            }
            
            // Build configuration based on visualization type
            const config = {
                title: document.getElementById('vizTitle').value || `${vizType.charAt(0).toUpperCase() + vizType.slice(1)} Chart`
            };
            
            if (vizType === 'bar') {
                config.x = document.getElementById('xAxisSelect').value;
                const yAxis = document.getElementById('yAxisSelect').value;
                if (yAxis) {
                    config.y = yAxis;
                }
                
                if (!config.x) {
                    alert('Please select an X-Axis column');
                    return;
                }
            } else if (vizType === 'line') {
                config.x = document.getElementById('xAxisSelect').value;
                config.y = document.getElementById('yAxisSelect').value;
                
                if (!config.x || !config.y) {
                    alert('Please select both X-Axis and Y-Axis columns');
                    return;
                }
            } else if (vizType === 'scatter') {
                config.x = document.getElementById('xAxisSelect').value;
                config.y = document.getElementById('yAxisSelect').value;
                const color = document.getElementById('colorSelect').value;
                if (color) {
                    config.color = color;
                }
                
                if (!config.x || !config.y) {
                    alert('Please select both X-Axis and Y-Axis columns');
                    return;
                }
            } else if (vizType === 'pie') {
                config.names = document.getElementById('namesSelect').value;
                config.values = document.getElementById('valuesSelect').value;
                
                if (!config.names) {
                    alert('Please select a Categories column');
                    return;
                }
            } else if (vizType === 'histogram') {
                config.x = document.getElementById('xAxisSelect').value;
                config.nbins = parseInt(document.getElementById('nbinsInput').value) || 20;
                
                if (!config.x) {
                    alert('Please select a Value column');
                    return;
                }
            } else if (vizType === 'box') {
                config.x = document.getElementById('xAxisSelect').value;
                config.y = document.getElementById('yAxisSelect').value;
                
                if (!config.x || !config.y) {
                    alert('Please select both Categories and Values columns');
                    return;
                }
            } else if (vizType === 'heatmap') {
                const selectedColumns = Array.from(document.querySelectorAll('.heatmap-column-checkbox:checked')).map(cb => cb.value);
                
                if (selectedColumns.length < 2) {
                    alert('Please select at least 2 columns for the heatmap');
                    return;
                }
                
                config.columns = selectedColumns;
            }
            
            // Create the visualization
            createVisualization(datasetId, vizType, config);
        });
        
        // Function to create a visualization
        function createVisualization(datasetId, vizType, config) {
            // Close the modal
            addVisualizationModal.hide();
            
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'alert alert-info';
            loadingDiv.innerHTML = '<i class="bi bi-hourglass"></i> Creating visualization...';
            document.querySelector('.container-fluid').appendChild(loadingDiv);
            
            // Get dataset ID from selection
            const datasetId = document.getElementById('datasetSelect').value;
            const dashboardId = document.getElementById('dashboardData').dataset.dashboardId; // ✅ Ensure this is read correctly

            if (!dashboardId || !datasetId) {
                alert('Please select a dataset.');
                return;
            }
            // Create the visualization on the server
            fetch('/dashboard/api/create_visualization', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dashboard_id: parseInt(dashboardId),  // ✅ Ensure it's an integer
                    dataset_id: parseInt(datasetId),  // ✅ Ensure it's an integer
                    type: vizType,
                    config: config,
                    position: { x: 0, y: 0, w: 6, h: 6 }
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                loadingDiv.remove();
                
                if (data.error) {
                    alert('Error creating visualization: ' + data.error);
                    return;
                }
                
                // Add the visualization to the grid
                const vizNode = {
                    id: data.id,
                    x: 0,
                    y: 0,
                    w: 6,
                    h: 6,
                    content: `
                        <div class="visualization-container" data-viz-id="${data.id}">
                            <div class="visualization-header">
                                <h5 class="visualization-title">${config.title || 'Visualization'}</h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary btn-sm edit-viz-btn" data-viz-id="${data.id}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-viz-btn" data-viz-id="${data.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="visualization-body" id="viz-${data.id}"></div>
                        </div>
                    `
                };
                
                grid.addWidget(vizNode);
                
                // Render the visualization
                if (data.data) {
                    Plotly.newPlot(`viz-${data.id}`, data.data.data, data.data.layout);
                }
                
                // Add event listeners for the new buttons
                setupDeleteButtons();
            })
            .catch(error => {
                // Remove loading indicator
                loadingDiv.remove();
                
                console.error('Error creating visualization:', error);
                alert('Failed to create visualization: ' + error.message);
            });
        }
        
        // Setup delete buttons for visualizations
        function setupDeleteButtons() {
            document.querySelectorAll('.delete-viz-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this visualization?')) {
                        const vizId = this.getAttribute('data-viz-id');
                        
                        // Delete the visualization on the server
                        fetch(`/dashboard/api/delete_visualization/${vizId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove the widget from the grid
                                const gridItem = document.querySelector(`.grid-stack-item[gs-id="${vizId}"]`);
                                if (gridItem) {
                                    grid.removeWidget(gridItem);
                                }
                            } else {
                                alert('Error deleting visualization: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting visualization:', error);
                            alert('Failed to delete visualization: ' + error.message);
                        });
                    }
                });
            });
        }
        
        // Initial setup of delete buttons
        setupDeleteButtons();
        
        // Handle window resize to redraw plots
        window.addEventListener('resize', function() {
            document.querySelectorAll('.visualization-body').forEach(vizBody => {
                Plotly.relayout(vizBody.id, {
                    autosize: true
                });
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let addBtn = document.getElementById('addVisualizationBtn');
            let saveBtn = document.getElementById('saveLayoutBtn');
        
            if (addBtn) {
                addBtn.addEventListener('click', function() {
                    console.log("Add Visualization button clicked");
                    addVisualizationModal.show();
                });
            }
        
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    console.log("Save Layout button clicked");
                    saveDashboardLayout();
                });
            }
        });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                let addBtn = document.getElementById('addVisualizationBtn');
                let saveBtn = document.getElementById('saveLayoutBtn');
            
                if (addBtn) {
                    addBtn.addEventListener('click', function() {
                        console.log("Add Visualization button clicked");
                        addVisualizationModal.show();
                    });
                }
            
                if (saveBtn) {
                    saveBtn.addEventListener('click', function() {
                        console.log("Save Layout button clicked");
                        saveDashboardLayout();
                    });
                }
            });
            
            // Function to save the dashboard layout
            function saveDashboardLayout() {
                const layout = {};
                grid.save().forEach(item => {
                    layout[item.id] = {
                        x: item.x,
                        y: item.y,
                        w: item.w,
                        h: item.h
                    };
                });
            
                fetch('/dashboard/api/update_dashboard_layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dashboard_id: document.getElementById('dashboardData').dataset.dashboardId,
                        layout: layout
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Layout saved successfully.");
                    } else {
                        alert("Failed to save layout: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error saving layout:", error);
                });
            }
            </script>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    let addBtn = document.getElementById('addVisualizationBtn');
                    let saveBtn = document.getElementById('saveLayoutBtn');
                
                    if (addBtn) {
                        addBtn.addEventListener('click', function() {
                            console.log("Add Visualization button clicked");
                            addVisualizationModal.show();
                        });
                    }
                
                    if (saveBtn) {
                        saveBtn.addEventListener('click', function() {
                            console.log("Save Layout button clicked");
                            saveDashboardLayout();
                        });
                    }
                
                    // Function to handle dataset selection and fetch visualization suggestions
                    document.getElementById('datasetSelect').addEventListener('change', function() {
                        const datasetId = this.value;
                        if (!datasetId) {
                            document.getElementById('visualizationSuggestions').style.display = 'none';
                            return;
                        }
                
                        // Show loading state
                        document.getElementById('visualizationSuggestions').style.display = 'block';
                        document.getElementById('suggestionsContainer').innerHTML = `<p>Loading suggestions...</p>`;
                
                        fetch(`/dashboard/api/dataset/${datasetId}/suggest_visualizations`)
                            .then(response => response.json())
                            .then(suggestions => {
                                let suggestionsHtml = '';
                                if (suggestions.length === 0) {
                                    suggestionsHtml = `<p>No visualization suggestions available.</p>`;
                                } else {
                                    suggestions.forEach((suggestion, index) => {
                                        suggestionsHtml += `
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>${suggestion.title}</h6>
                                                    <p>${suggestion.description}</p>
                                                    <button class="btn btn-primary add-suggestion-btn"
                                                        data-suggestion-index="${index}"
                                                        data-dataset-id="${datasetId}">
                                                        Add to Dashboard
                                                    </button>
                                                </div>
                                            </div>`;
                                    });
                                }
                
                                document.getElementById('suggestionsContainer').innerHTML = suggestionsHtml;
                
                                // Add click event for suggestion buttons
                                document.querySelectorAll('.add-suggestion-btn').forEach(button => {
                                    button.addEventListener('click', function() {
                                        const suggestionIndex = parseInt(this.getAttribute('data-suggestion-index'));
                                        const datasetId = this.getAttribute('data-dataset-id');
                                        const suggestion = suggestions[suggestionIndex];
                
                                        createVisualization(datasetId, suggestion.type, suggestion.config);
                                    });
                                });
                            })
                            .catch(error => {
                                console.error("Error fetching suggestions:", error);
                            });
                    });
                });
                </script>
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        let addBtn = document.getElementById('addVisualizationBtn');
                        let saveBtn = document.getElementById('saveLayoutBtn');
                    
                        if (addBtn) {
                            addBtn.addEventListener('click', function() {
                                console.log("Add Visualization button clicked");
                                addVisualizationModal.show();
                            });
                        }
                    
                        if (saveBtn) {
                            saveBtn.addEventListener('click', function() {
                                console.log("Save Layout button clicked");
                                saveDashboardLayout();
                            });
                        }
                    
                        // Function to handle dataset selection and fetch visualization suggestions
                        document.getElementById('datasetSelect').addEventListener('change', function() {
                            const datasetId = this.value;
                            if (!datasetId) {
                                document.getElementById('visualizationSuggestions').style.display = 'none';
                                return;
                            }
                    
                            // Show loading state
                            document.getElementById('visualizationSuggestions').style.display = 'block';
                            document.getElementById('suggestionsContainer').innerHTML = `<p>Loading suggestions...</p>`;
                    
                            fetch(`/dashboard/api/dataset/${datasetId}/suggest_visualizations`)
                                .then(response => response.json())
                                .then(suggestions => {
                                    let suggestionsHtml = '';
                                    if (suggestions.length === 0) {
                                        suggestionsHtml = `<p>No visualization suggestions available.</p>`;
                                    } else {
                                        suggestions.forEach((suggestion, index) => {
                                            suggestionsHtml += `
                                                <div class="card">
                                                    <div class="card-body">
                                                        <h6>${suggestion.title}</h6>
                                                        <p>${suggestion.description}</p>
                                                        <button class="btn btn-primary add-suggestion-btn"
                                                            data-suggestion-index="${index}"
                                                            data-dataset-id="${datasetId}">
                                                            Add to Dashboard
                                                        </button>
                                                    </div>
                                                </div>`;
                                        });
                                    }
                    
                                    document.getElementById('suggestionsContainer').innerHTML = suggestionsHtml;
                    
                                    // Add click event for suggestion buttons
                                    document.querySelectorAll('.add-suggestion-btn').forEach(button => {
                                        button.addEventListener('click', function() {
                                            const suggestionIndex = parseInt(this.getAttribute('data-suggestion-index'));
                                            const datasetId = this.getAttribute('data-dataset-id');
                                            const suggestion = suggestions[suggestionIndex];
                    
                                            createVisualization(datasetId, suggestion.type, suggestion.config);
                                        });
                                    });
                                })
                                .catch(error => {
                                    console.error("Error fetching suggestions:", error);
                                });
                        });
                    });
                    
                    // Function to create a new visualization
                    function createVisualization(datasetId, vizType, config) {
                        const dashboardId = document.getElementById('dashboardData').dataset.dashboardId;
                        if (!dashboardId || !datasetId) {
                            alert("Please select a dataset.");
                            return;
                        }
                    
                        fetch('/dashboard/api/create_visualization', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dashboard_id: parseInt(dashboardId),
                                dataset_id: parseInt(datasetId),
                                type: vizType,
                                config: config,
                                position: { x: 0, y: 0, w: 6, h: 6 }
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert("Error creating visualization: " + data.error);
                                return;
                            }
                            console.log("Visualization Created:", data);
                            alert("Visualization successfully added!");
                            location.reload();  // Refresh page to show the new visualization
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("Failed to create visualization: " + error.message);
                        });
                    }
                    </script>
</body>
</html>